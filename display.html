<!DOCTYPE html>
<html>
    <head>
        <title>Constellation</title>
        <script type="text/javascript">
            var sky = [];
            var links = [];
            var linkA = null;
            
            var IDSPACE = 16384;
            
            class Star {
                get element() {
                    return this._element;
                }
            
                get x() {
                    return this._x;
                }
                set x(value) {
                    this._x = value;
                    this._refresh();
                }
                get y() {
                    return this._y;
                }
                set y(value) {
                    this._y = value;
                    this._refresh();
                }
            
                get size() {
                    return this._size;
                }
                set size(value) {
                    this._size = value;
                    this._refresh();
                }
            
                get colour() {
                    return this._colour;
                }
                set colour(value) {
                    this._colour = value;
                    this._refresh();
                }
            
                constructor(x, y, size, id, colour="#ffffff", debug=true) {
                    this._x = x;
                    this._y = y;
                    this._size = size;
                    this._colour = colour;
                    this._id = id;
                    this._links = [];
                    this.debug = debug;
                    let canvas = document.getElementById("canvas");
                    canvas.insertAdjacentHTML("beforeend", '<g id="star' + this._id.toString() + '" class="star" style="fill:' + colour + ';transform-origin:' + x.toString() + 'px ' + y.toString() + 'px" transform="scale(' + size.toString() + ') translate(' + x.toString() + ',' + y.toString() + ')"><circle r="1" class="outer"></circle><circle r="1"></circle></g>');
                    this._element = document.getElementById("star" + this._id.toString());
                    this.element.addEventListener('click', e => {this.onclick(this, e);});
                    var e = this.element;
                    setTimeout(function() {
                        e.firstChild.style.animationPlayState = "running";
                    }, Math.random() * 5000);
                }
                _refresh() {
                    this.element.setAttribute("transform", 'scale(' + this._size.toString() + ') translate(' + this._x.toString() + ',' + this._y.toString() + ')');
                    this.element.setAttribute("style", 'fill:' + this._colour + ';transform-origin:' + this._x.toString() + 'px ' + this._y.toString() + 'px');
                    for (let i = 0; i < this._links.length; i++) {
                        this._links[i]._refresh();
                    }
                }
            
                onclick(self, e) {
                    console.log("Star clicked at (" + self.x.toString() + ", " + self.y.toString() + ").");
                    if (linkA) {
                        if (linkA != self) {
                            if (linkA.x <= self.x) {
                                if (linkA.y <= self.y) {
                                    links.push(new Linker(linkA, self));
                                } else {
                                    links.push(new Linker(self, linkA));
                                }
                            } else {
                                links.push(new Linker(self, linkA));
                            }
                        }
                        linkA = null;
                    } else {
                        linkA = self;
                    }
                }
            }
            
            class Linker {
                get element() {
                    return this._element;
                }
            
                get thickness() {
                    return this._thickness;
                }
                set thickness(value) {
                    this._thickness = value;
                    this._refresh();
                }
            
                constructor(pointA, pointB) {
                    this.colour = "#ffffff"
                    this._origin = pointA;
                    this._dest = pointB;
                    pointA._links.push(this);
                    pointB._links.push(this);
                    this._num = pointA._id * IDSPACE + pointB._id;
                    this._thickness = 4;
                    this._x = this._origin.x - this._thickness / 2;
                    this._y = this._origin.y;
                    this._dx = this._dest.x - this._thickness / 2;
                    this._dy = this._dest.y;
                    this._length = Math.sqrt(Math.pow(this._x - this._dx, 2) + Math.pow(this._y - this._dy, 2));
                    this._rotation = Math.atan((this._y - this._dy) / (this._x - this._dx)) * 180 / Math.PI;
                    if (this._y <= this._dy && this._x >= this._dx) {
                        this._rotation += 180;
                    }
                    let code = '<rect id="link' + this._num + '" class="link" x="' + this._x.toString() + '" y="' + this._y.toString() + '" width="' + this._thickness.toString() + '" height="' + this._length.toString() + '" style="fill:' + this.colour + ';transform-origin:' + (this._x + this._thickness / 2).toString() + 'px ' + this._y.toString() + 'px" transform="rotate(' + (this._rotation - 90).toString() + ')"></rect>';
                    var back = document.getElementById("back");
                    back.insertAdjacentHTML("afterend", code);
                    this._element = document.getElementById("link" + this._num);
                }
            
                queryPoint(node) {
                    if (node == this._origin) {
                        return 1;
                    } else if (node == this._dest) {
                        return 2;
                    } else {
                        return 0;
                    }
                }
            
                _refresh() {
                    this._x = this._origin.x - this._thickness / 2;
                    this._y = this._origin.y;
                    this._dx = this._dest.x - this._thickness / 2;
                    this._dy = this._dest.y;
                    this._length = Math.sqrt(Math.pow(this._x - this._dx, 2) + Math.pow(this._y - this._dy, 2));
                    this._rotation = Math.atan((this._y - this._dy) / (this._x - this._dx)) * 180 / Math.PI;
                    if (this._y <= this._dy && this._x >= this._dx) {
                        this._rotation += 180;
                    }
                    this.element.setAttribute("x", this._x.toString());
                    this.element.setAttribute("y", this._y.toString());
                    this.element.setAttribute("width", this._thickness.toString());
                    this.element.setAttribute("height", this._length.toString());
                    this.element.setAttribute("style", 'fill:' + this.colour + ';transform-origin:' + (this._x + this._thickness / 2).toString() + 'px ' + this._y.toString() + 'px');
                    this.element.setAttribute("transform", 'rotate(' + (this._rotation - 90).toString() + ')');
                }
            }
            
            function start(mapper, callback) {
                console.log(mapper);
                var stars = mapper();
                for (let i = 0; i < stars.length; i++) {
                    sky.push(new Star(stars[i][0], stars[i][1], stars[i][2], sky.length));
                }
                document.addEventListener("keydown", function calculate(e) {
                    if (e.key == "Enter") {
                        var final = new Uint8Array(links.length * 4);
                        links.sort((a, b) => a._num - b._num);
                        var box = document.getElementById("canvas").getAttribute("viewBox").split(" ");
                        for (let i = 0; i < links.length; i++) {
                            final[i * 4] = links[i]._origin.x / (box[2] / 256);
                            final[i * 4 + 1] = links[i]._origin.y / (box[3] / 256);
                            final[i * 4 + 2] = links[i]._dest.x / (box[2] / 256);
                            final[i * 4 + 3] = links[i]._dest.y / (box[3] / 256);
                        }
                        callback(final);
                    }
                });
            }
        </script>
        <style type="text/css">
        body {
            background-color: midnightblue;
            padding: 0px;
            margin: 0px;
        }

        @keyframes twinkle {
            0% {
                transform: scale(1);
                opacity: 0.4;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0.4;
            }
        }
        @keyframes link-twinkle {
            0% {
                opacity: 0.2;
            }
            50% {
                opacity: 0.8;
            }
            100% {
                opacity: 0.2;
            }
        }

        .star > * {
            animation: twinkle 5s ease infinite;
            animation-play-state: paused;
            transition-duration: 200ms;
        }
        .link {
            animation: link-twinkle 5s ease infinite;
        }

        .star:hover > * {
            transform: scale(4) !important;
        }
        </style>
    </head>
    <body>
        <svg version="1.1" id="canvas" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 400" xml:space="preserve">
            <rect width="100%" height="100%" fill="#001933" id="back"/>
        </svg>
        <script>
            var checker = setInterval(function() {
                if (window.opener.starMapper) {
                    start(window.opener.starMapper, function(value) {
                        window.opener.constellationHandler(value);
                        window.close();
                    });
                    clearInterval(checker);
                }
            }, 20);
        </script>
    </body>
</html>